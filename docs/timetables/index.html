<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Laguna Seca Lap Times</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="styles/styles.css" rel="stylesheet">
</head>
<body class="bg-black min-h-screen text-white p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-light mb-6 text-center">Laguna Seca Lap Times</h1>
    <div class="mb-4">
      <input
        type="text"
        id="search-input"
        placeholder="Search cars (e.g. Ferrari, 2018, 01:10)"
        class="w-full p-2 rounded-md bg-gray-800 text-white placeholder-gray-500 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
    </div>
    <table class="w-full border-separate border-spacing-y-2 text-sm md:text-base">
      <thead class="uppercase text-gray-400 text-xs border-b border-gray-700">
        <tr>
          <th class="text-left px-4 py-2">Car</th>
          <th class="text-left px-4 py-2 cursor-pointer" data-sort="lapTime" data-key="lapTime">Lap Time</th>
          <th class="text-left px-4 py-2 cursor-pointer" data-sort="make" data-key="make">Brand</th>
          <th class="text-left px-4 py-2 cursor-pointer" data-sort="year" data-key="year">Year</th>
          <th class="text-right px-4 py-2">Details</th>
        </tr>
      </thead>
      <tbody id="car-table-body" class="text-white"></tbody>
    </table>
    <div id="pagination" class="mt-4 flex justify-center space-x-2 text-white"></div>

  </div>

  <script>
  const rowsPerPage = 10;  // how many cars per page
  let currentPage = 1;
  const tbody = document.getElementById("car-table-body");
  const searchInput = document.getElementById("search-input");
  let allCars = [];
  let currentSort = { key: null, ascending: true };

  fetch('./data/cars.json')
    .then(response => response.json())
    .then(cars => {
      allCars = cars;
      updateTable(); // render initially
    });

  function updateTable() {
    let filtered = applyFilter(allCars);
    let sorted = applySort(filtered);
    const totalPages = Math.ceil(sorted.length / rowsPerPage);
    if (currentPage > totalPages) currentPage = totalPages || 1;

    // Calculate slice indexes
    const startIdx = (currentPage - 1) * rowsPerPage;
    const endIdx = startIdx + rowsPerPage;
    const pageItems = sorted.slice(startIdx, endIdx);

    // Pass pairs with global index
    const pageItemsWithIndex = pageItems.map((car, i) => ({car, globalIndex: startIdx + i}));

    renderTable(pageItemsWithIndex);
    renderPagination(totalPages);
    updateSortIndicators()
  }

  function updateSortIndicators() {
    document.querySelectorAll("th[data-sort]").forEach(th => {
      const key = th.getAttribute("data-sort");
      th.innerHTML = th.textContent.replace(/[\u25B2\u25BC]/g, '').trim(); // remove arrows
      if (key === currentSort.key) {
        th.innerHTML += currentSort.ascending ? " ▲" : " ▼";
      }
    });
  }

  function renderPagination(totalPages) {
    const paginationDiv = document.getElementById('pagination');
    paginationDiv.innerHTML = '';

    if (totalPages <= 1) return;  // no pagination needed

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.className = `px-3 py-1 rounded ${i === currentPage ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}`;
      btn.addEventListener('click', () => {
        currentPage = i;
        updateTable();
      });
      paginationDiv.appendChild(btn);
    }
  }

  function applyFilter(cars) {
    const query = searchInput.value.toLowerCase();
    return cars.filter(car =>
      car.model.toLowerCase().includes(query) ||
      car.make.toLowerCase().includes(query) ||
      car.year.toString().includes(query) ||
      car.lapTime.toLowerCase().includes(query)
    );
  }

  function applySort(cars) {
    const { key, ascending } = currentSort;
    if (!key) return cars;

    return [...cars].sort((a, b) => {
      let valA = a[key];
      let valB = b[key];

      if (key === "lapTime") {
        const timeToMs = t => {
          const [min, sec] = t.split(':').map(parseFloat);
          return min * 60000 + sec * 1000;
        };
        valA = timeToMs(valA);
        valB = timeToMs(valB);
      } else if (key === "year") {
        valA = parseInt(valA);
        valB = parseInt(valB);
      } else {
        valA = valA.toLowerCase();
        valB = valB.toLowerCase();
      }

      if (valA < valB) return ascending ? -1 : 1;
      if (valA > valB) return ascending ? 1 : -1;
      return 0;
    });
  }

  function renderTable(carsWithIndex) {
    tbody.innerHTML = "";
    carsWithIndex.forEach(({car,globalIndex}) => {
    //cars.forEach((car, index) => {
      const rowId = `details-${globalIndex}`;
      const res = car.resources || {};
      tbody.innerHTML += `
        <tr class="bg-gray-900/80 hover:bg-blue-600/20 transition-all duration-200 shadow-md rounded-lg overflow-hidden cursor-pointer border border-gray-700" onclick="toggleDetails('${rowId}')">
          <td class="px-4 py-3 tracking-wide text-white text-sm">${car.model}</td>
          <td data-key="lapTime" class="px-4 py-3 text-white text-sm">${car.lapTime}</td>
          <td data-key="make" class="px-4 py-3 text-white text-sm">${car.make}</td>
          <td data-key="year" class="px-4 py-3 text-white text-sm">${car.year}</td>
          <td class="px-4 py-3 text-right text-sm text-blue-400 hover:text-blue-200">Details →</td>
        </tr>
        <tr class="hidden bg-gray-800/90 text-sm text-gray-300 border-t border-gray-700" id="${rowId}">
          <td colspan="5" class="p-4">
            <div class="flex gap-4 items-center">
              <img src="${car.image}" alt="${car.model}" class="w-32 rounded shadow-md" onerror="this.onerror=null; this.src='./img/notfound.jpg';" />
              <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm flex-1">
                <div><span class="font-semibold">Power:</span> ${car.power}</div>
                <div><span class="font-semibold">Torque:</span> ${car.torque}</div>
                <div><span class="font-semibold">Weight:</span> ${car.weight}</div>
                <div><span class="font-semibold">Date:</span> ${car.date}</div>
                <div><span class="font-semibold">Notes:</span> ${car.notes}</div>
                <div><span class="font-semibold">Resources:</span>
                  <ul class="list-disc list-inside">
                    <li><a href="${res.specs || '#'}" class="text-blue-600 hover:underline">Official Specs</a></li>
                    <li><a href="${res.onboard || '#'}" class="text-blue-600 hover:underline">Onboard Lap</a></li>
                    <li><a href="${res.mod || '#'}" class="text-blue-600 hover:underline">Car Mod Page</a></li>
                  </ul>
                </div>
              </div>
            </div>
          </td>
        </tr>
      `;
    });
  }

  function toggleDetails(id) {
    document.getElementById(id).classList.toggle("hidden");
  }

  searchInput.addEventListener("input", () => {
    currentPage = 1; // reset to first page on search
    updateTable();
  });

    // Sorting
  document.querySelectorAll("th[data-sort]").forEach(th => {
    th.addEventListener("click", () => {
      const key = th.getAttribute("data-sort");
      if (currentSort.key === key) {
        currentSort.ascending = !currentSort.ascending;
      } else {
        currentSort.key = key;
        currentSort.ascending = true;
      }
      updateTable();
    });
  });
  </script>
</body>
</html>
